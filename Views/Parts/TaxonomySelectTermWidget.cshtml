@using System.Text
@using Orchard.Taxonomies.Models
@{
	Script.Require("jQuery").AtHead();
	//Script.Include("/Themes/ISkyTheme/Scripts/TickScroll.min.js").AtHead(); 
} 
@using(Html.BeginFormAntiForgeryPost())
{
	<select name="terms" class="tax-terms">
		@Html.SelectOption("", false, "All")
		@foreach(TermPart term in Model.Terms) {
			var depth = Math.Max(term.FullPath.Split('/').Count() - 2, 0) * 2;
			var termName = new StringBuilder().Append('-', depth);
			termName.Append(term.Name);

			@Html.SelectOption((int)Model.LastTermId, term.Id, termName.ToString())
		}
	</select>
	<button>@T("Search")</button>
}
<script type="text/javascript">
	var selectbox;
	var allTerms;
	$(window).load(function () {
		selectbox = $(".tax-terms");
		allTerms = tList(0, 0, selectbox[0], selectbox[0].length);
		var newSelect = $("<select/>");
		newSelect.change(onSelectOption);
		populateTerms(allTerms, newSelect[0], 0);
		selectbox.before(newSelect);

		var currentIndex = firstSelected(allTerms);
		newSelect[0].selectedIndex = currentIndex;
		populateSubTermsFor(currentIndex, true);

		// Todo:
		// 1. Add all option for 2nd level
	});

	function tList(place, level, selectOptions, numOptions) {
		var terms = [];
		for (var i = place; i < numOptions; i++) {
			var currentLevel = indentLevel(selectOptions[i].text);
			if (currentLevel == level) {
				var text = selectOptions[i].text.substring(level * 2);
				terms.push({ value: selectOptions[i].value, text: text, selected: selectOptions[i].selected });
			}
			else if (currentLevel > level) {
				var subTerms = tList(i, currentLevel, selectOptions, numOptions);
				terms[terms.length - 1].terms = subTerms;
				terms[terms.length - 1].selected = anySelected(subTerms);
				i += subTerms.length - 1;
			}
			else {
				return terms;
			}

		}
		return terms;
	}

	function anySelected(terms) {
		return firstSelected(terms) != null;
	}

	function firstSelected(terms) {
		var termsLength = terms.length;
		for (var i = 0; i < termsLength; i++) {
			if (terms[i].selected) return i;
		}
		return null;
	}

	function indentLevel(text) {
		var textLength = text.length;
		for (var i = 0; i < textLength; i++) {
			if (text.charAt(i) != '-') return i / 2;
		}
		return 0;
	}

	function populateTerms(terms, selectbox, selectedIndex) {
		selectbox.innerHTML = null;
		var termsLength = terms.length;
		for (var i = 0; i < termsLength; i++) {
			selectbox.add(new Option(terms[i].text, terms[i].value));
		}
		selectbox.selectedIndex = selectedIndex;
	}

	function onSelectOption(e) {
		populateSubTermsFor(e.currentTarget.selectedIndex, false);
	}

	function populateSubTermsFor(i, checkSelected) {
		selectbox[0].innerHTML = null;
		var subTerms = allTerms[i].terms;
		var subSelectedIndex = checkSelected
			? firstSelected(subTerms)
			: 0;
		if (subTerms) {
			populateTerms(subTerms, selectbox[0], subSelectedIndex);
		}
	}
</script>
@* <script$(window).load(function () {$(".widget-headlines").TickScroll();});</script> *@